[gd_scene load_steps=21 format=2]

[ext_resource path="res://Assets/Sprites/Ships/playerShip2_blue.png" type="Texture" id=1]
[ext_resource path="res://Nodes/Agents/PlayerBullet.tscn" type="PackedScene" id=2]
[ext_resource path="res://Nodes/Agents/Arrow.tscn" type="PackedScene" id=3]
[ext_resource path="res://Nodes/Agents/DetectionArrow.gd" type="Script" id=4]
[ext_resource path="res://Assets/Sprites/Anim/BlinkRed.tres" type="Animation" id=5]
[ext_resource path="res://Assets/Sprites/Ships/Damage/playerShip2_damage2.png" type="Texture" id=6]
[ext_resource path="res://Assets/Sprites/Ships/Damage/playerShip2_damage3.png" type="Texture" id=7]
[ext_resource path="res://Assets/Sprites/Ships/Damage/playerShip2_damage1.png" type="Texture" id=8]
[ext_resource path="res://Assets/Sprites/Anim/Shield/shield3.png" type="Texture" id=9]
[ext_resource path="res://Assets/Sprites/Anim/Shield/shield1.png" type="Texture" id=10]
[ext_resource path="res://Assets/Sprites/Anim/Shield/shield2.png" type="Texture" id=11]

[sub_resource type="GDScript" id=1]
script/source = "extends KinematicBody2D

export (int) var SPEED = 600
export (int) var INERTIA = 200
export (int) var HP = 100
export (int) var SHIELD = 100

export (PackedScene) var Bullet

var velocity = Vector2()
var prev_velocity = Vector2()
var is_moving = false

export (float) var firerate = 0.7
export (Array) var DamageSprite

signal health_changed(health)
signal shield_changed(shield)
signal end_game(wave)

var dir = Vector2()
var canshoot = true

var nb_wave = 0

var speed : int

func _ready():
	speed = SPEED
	$ShootTimer.wait_time = firerate
	
func _on_ShootTimer_timeout():
	canshoot = true

func _process(delta):
	if HP < 75:
		$Sprite/Damage.texture = DamageSprite[0]
	if HP < 50:
		$Sprite/Damage.texture = DamageSprite[1]
	if HP < 25:
		$Sprite/Damage.texture = DamageSprite[2]

func _physics_process(delta):
	update()
	get_input(delta)
	velocity = move_and_slide(velocity)

# warning-ignore:unused_argument
func get_input(delta):
	look_at(get_global_mouse_position())

	velocity = Vector2.ZERO
	is_moving = false
	if (Input.is_action_pressed(\"fire\") and canshoot):
		shoot()
	if (Input.is_action_pressed(\"move_up\")):
		velocity.y -= 1
		is_moving = true
	if (Input.is_action_pressed(\"move_left\")):
		velocity.x -= 1
		is_moving = true
	if (Input.is_action_pressed(\"move_down\")):
		velocity.y += 1
		is_moving = true
	if (Input.is_action_pressed(\"move_right\")):
		velocity.x += 1
		is_moving = true

	if (is_moving):
		velocity = velocity.normalized() * speed
		prev_velocity = velocity
	else:
		velocity = prev_velocity.normalized() * INERTIA

func shoot():
	var b = Bullet.instance()
	b.start(global_position, (get_global_mouse_position() - position).normalized()) #+ rand_range(-0.05, 0.05))
	get_parent().add_child(b)
	canshoot = false
	$ShootTimer.start()

func takedamage(nb):
	HP -= nb
	$AnimationPlayer.play(\"BlinkRed\")
	$Shield.reset_timer()
	emit_signal(\"health_changed\", HP)
	if HP <= 0:
		emit_signal(\"end_game\", nb_wave)
		queue_free()
		get_tree().change_scene(\"res://Nodes/Interface/Menu/game_over_menu.tscn\")

func _on_Shield_shield_changed(shield):
	emit_signal(\"shield_changed\", shield)


func _on_Spawns_spawn_changed(spawn_pos):
	$DetectionArrow.target = spawn_pos


func _on_Spawns_wave_changed(wave):
	nb_wave = wave
"

[sub_resource type="GDScript" id=2]
script/source = "extends Camera2D


var Player
var target = Vector2()
var mouse_pos = Vector2()

var distance_max : int
var win_size = Vector2()

func _ready():
	Player = get_parent()
	target = Vector2.ZERO
	mouse_pos = Vector2.ZERO
	Input.set_mouse_mode(Input.MOUSE_MODE_CONFINED)
	
	set_mouse_margin()

# warning-ignore:unused_argument
func _process(delta):
	if win_size != OS.window_size:
		set_mouse_margin()

func _input(event):
	if event is InputEventMouseMotion:
		mouse_pos = get_global_mouse_position()
		target = global_position.distance_to(mouse_pos) / 2
		if target > distance_max:
			target = distance_max
		offset = global_position.direction_to(mouse_pos) * target
	
	if event.is_action_pressed(\"pause\"):
		Input.set_mouse_mode(Input.MOUSE_MODE_VISIBLE)
	
	if event is InputEventMouseButton:
		Input.set_mouse_mode(Input.MOUSE_MODE_CONFINED)

func set_mouse_margin():
	win_size = OS.window_size
	var win_min_size : float = min(win_size.x, win_size.y)
# warning-ignore:narrowing_conversion
	distance_max = win_min_size - win_min_size / 5
"

[sub_resource type="CircleShape2D" id=3]
radius = 32.2242

[sub_resource type="GDScript" id=4]
script/source = "extends RigidBody2D

export (int) var REGEN_SPEED = 2

var shield : float
var has_been_shot = false
var regen_shield = true

signal shield_changed(shield)

func _ready():
	shield = get_parent().SHIELD

func _process(delta):
	if shield == get_parent().SHIELD:
		regen_shield = false
	regenerate_shield(delta)

func takedamage(nb):
	regen_shield = false
	$AnimationPlayer.play(\"ShieldDamage\")
	shield -= nb
	if shield <= 0:
		shield_enabled(false)
	emit_signal(\"shield_changed\", shield)

func shield_enabled(var enabled : bool):
	if enabled:
		$AnimationPlayer.play(\"ShieldActivate\")
	else:
		$AnimationPlayer.play(\"ShieldDeactivate\")
		shield = 0
		$ShieldTimer.start()

func regenerate_shield(delta):
	if not regen_shield:
		return
	if shield < get_parent().SHIELD:
		shield += delta * REGEN_SPEED
		emit_signal(\"shield_changed\", shield)

func reset_timer():
	$ShieldTimer.stop()
	$ShieldTimer.start()

func _on_ShieldTimer_timeout():
	shield_enabled(true)
	regen_shield = true
"

[sub_resource type="CircleShape2D" id=5]
radius = 71.3621

[sub_resource type="Animation" id=6]
resource_name = "ShieldActivate"
length = 0.15
step = 0.05
tracks/0/type = "value"
tracks/0/path = NodePath("Sprite:texture")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/keys = {
"times": PoolRealArray( 0, 0.05, 0.1, 0.15 ),
"transitions": PoolRealArray( 1, 1, 1, 1 ),
"update": 1,
"values": [ null, ExtResource( 10 ), ExtResource( 11 ), ExtResource( 9 ) ]
}
tracks/1/type = "value"
tracks/1/path = NodePath("CollisionShape2D:disabled")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/keys = {
"times": PoolRealArray( 0.05 ),
"transitions": PoolRealArray( 1 ),
"update": 1,
"values": [ false ]
}
tracks/2/type = "value"
tracks/2/path = NodePath("Sprite:visible")
tracks/2/interp = 1
tracks/2/loop_wrap = true
tracks/2/imported = false
tracks/2/enabled = true
tracks/2/keys = {
"times": PoolRealArray( 0 ),
"transitions": PoolRealArray( 1 ),
"update": 1,
"values": [ true ]
}

[sub_resource type="Animation" id=7]
resource_name = "ShieldDamage"
length = 0.1
step = 0.05
tracks/0/type = "value"
tracks/0/path = NodePath("Sprite:texture")
tracks/0/interp = 0
tracks/0/loop_wrap = true
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/keys = {
"times": PoolRealArray( 0, 0.05, 0.1 ),
"transitions": PoolRealArray( 1, 1, 1 ),
"update": 1,
"values": [ ExtResource( 11 ), ExtResource( 11 ), ExtResource( 9 ) ]
}
tracks/1/type = "value"
tracks/1/path = NodePath("CollisionShape2D:disabled")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/keys = {
"times": PoolRealArray( 0 ),
"transitions": PoolRealArray( 1 ),
"update": 1,
"values": [ false ]
}
tracks/2/type = "value"
tracks/2/path = NodePath("Sprite:visible")
tracks/2/interp = 1
tracks/2/loop_wrap = true
tracks/2/imported = false
tracks/2/enabled = true
tracks/2/keys = {
"times": PoolRealArray( 0 ),
"transitions": PoolRealArray( 1 ),
"update": 1,
"values": [ true ]
}

[sub_resource type="Animation" id=8]
resource_name = "ShieldDeactivate"
length = 0.15
step = 0.05
tracks/0/type = "value"
tracks/0/path = NodePath("Sprite:texture")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/keys = {
"times": PoolRealArray( 0, 0.05, 0.1, 0.15 ),
"transitions": PoolRealArray( 1, 1, 1, 1 ),
"update": 1,
"values": [ ExtResource( 9 ), ExtResource( 11 ), ExtResource( 10 ), null ]
}
tracks/1/type = "value"
tracks/1/path = NodePath("CollisionShape2D:disabled")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/keys = {
"times": PoolRealArray( 0.15 ),
"transitions": PoolRealArray( 1 ),
"update": 1,
"values": [ true ]
}
tracks/2/type = "value"
tracks/2/path = NodePath("Sprite:visible")
tracks/2/interp = 1
tracks/2/loop_wrap = true
tracks/2/imported = false
tracks/2/enabled = true
tracks/2/keys = {
"times": PoolRealArray( 0.15 ),
"transitions": PoolRealArray( 1 ),
"update": 1,
"values": [ false ]
}

[sub_resource type="Animation" id=9]
resource_name = "ShieldFull"
length = 0.001
step = 0.2
tracks/0/type = "value"
tracks/0/path = NodePath("Sprite:texture")
tracks/0/interp = 1
tracks/0/loop_wrap = true
tracks/0/imported = false
tracks/0/enabled = true
tracks/0/keys = {
"times": PoolRealArray( 0 ),
"transitions": PoolRealArray( 1 ),
"update": 1,
"values": [ ExtResource( 9 ) ]
}
tracks/1/type = "value"
tracks/1/path = NodePath("Sprite:visible")
tracks/1/interp = 1
tracks/1/loop_wrap = true
tracks/1/imported = false
tracks/1/enabled = true
tracks/1/keys = {
"times": PoolRealArray( 0 ),
"transitions": PoolRealArray( 1 ),
"update": 1,
"values": [ true ]
}
tracks/2/type = "value"
tracks/2/path = NodePath("CollisionShape2D:disabled")
tracks/2/interp = 1
tracks/2/loop_wrap = true
tracks/2/imported = false
tracks/2/enabled = true
tracks/2/keys = {
"times": PoolRealArray( 0 ),
"transitions": PoolRealArray( 1 ),
"update": 1,
"values": [ false ]
}

[node name="Player" type="KinematicBody2D"]
collision_mask = 43
script = SubResource( 1 )
SHIELD = 15
Bullet = ExtResource( 2 )
DamageSprite = [ ExtResource( 8 ), ExtResource( 6 ), ExtResource( 7 ) ]

[node name="Sprite" type="Sprite" parent="."]
rotation = 1.5708
texture = ExtResource( 1 )

[node name="Damage" type="Sprite" parent="Sprite"]

[node name="CollisionShape2D" type="CollisionPolygon2D" parent="."]
position = Vector2( -1, 0 )
build_mode = 1
polygon = PoolVector2Array( -4.88318, -55.7356, -32.4251, -37.7735, -37.215, -0.651672, -34.2213, 37.0688, -3.6857, 55.031, 17.8689, 10.7243, 41.2197, 0.545792, 17.8689, -15.0214 )

[node name="Camera2D" type="Camera2D" parent="."]
current = true
zoom = Vector2( 2, 2 )
smoothing_enabled = true
script = SubResource( 2 )

[node name="ShootTimer" type="Timer" parent="."]
wait_time = 0.5

[node name="DetectionArrow" type="Area2D" parent="."]
collision_layer = 16
collision_mask = 2
script = ExtResource( 4 )
Arrow = ExtResource( 3 )

[node name="DetectionArrow" type="CollisionShape2D" parent="DetectionArrow"]
visible = false
scale = Vector2( 200, 200 )
shape = SubResource( 3 )

[node name="AnimationPlayer" type="AnimationPlayer" parent="."]
anims/BlinkRed = ExtResource( 5 )

[node name="Shield" type="RigidBody2D" parent="."]
rotation = 1.5708
collision_layer = 128
collision_mask = 34
mode = 1
gravity_scale = 0.0
contacts_reported = 100
contact_monitor = true
script = SubResource( 4 )

[node name="Sprite" type="Sprite" parent="Shield"]
texture = ExtResource( 9 )

[node name="CollisionShape2D" type="CollisionShape2D" parent="Shield"]
shape = SubResource( 5 )

[node name="AnimationPlayer" type="AnimationPlayer" parent="Shield"]
autoplay = "ShieldFull"
anims/ShieldActivate = SubResource( 6 )
anims/ShieldDamage = SubResource( 7 )
anims/ShieldDeactivate = SubResource( 8 )
anims/ShieldFull = SubResource( 9 )

[node name="ShieldTimer" type="Timer" parent="Shield"]
wait_time = 4.0
[connection signal="timeout" from="ShootTimer" to="." method="_on_ShootTimer_timeout"]
[connection signal="body_entered" from="DetectionArrow" to="DetectionArrow" method="_on_DetectionArrow_body_entered"]
[connection signal="body_exited" from="DetectionArrow" to="DetectionArrow" method="_on_DetectionArrow_body_exited"]
[connection signal="shield_changed" from="Shield" to="." method="_on_Shield_shield_changed"]
[connection signal="timeout" from="Shield/ShieldTimer" to="Shield" method="_on_ShieldTimer_timeout"]
